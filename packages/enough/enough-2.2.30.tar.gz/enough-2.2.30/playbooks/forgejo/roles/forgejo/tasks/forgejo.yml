---
- name: apt-get install virtualenv python3-pip
  apt:
    name: [ virtualenv, python3-pip ]
    state: present

- name: pip install docker
  pip:
    name: docker

- name: mkdir /srv/forgejo
  file:
    state: directory
    path: /srv/forgejo
    mode: 0755
    owner: 1000
    group: 1000
  become: true

- name: start forgejo
  docker_container:
    name: forgejo
    image: "{{ forgejo_image }}:{{ forgejo_version }}"
    restart_policy: always
    ports:
      - "22:22"
      - "8080:3000"
    volumes:
      - /srv/forgejo:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/local/share/ca-certificates/infrastructure:/usr/local/share/ca-certificates/infrastructure:ro
    env:
      USER_UID: "1000"
      USER_GID: "1000"
      LFS_START_SERVER: "true"
      FORGEJO__security__INSTALL_LOCK: "true"
      FORGEJO__server__DOMAIN: "{{ forgejo_host }}"
      FORGEJO__server__SSH_DOMAIN: "{{ forgejo_host }}"
      FORGEJO__server__ROOT_URL: "https://{{ forgejo_host }}/"
      FORGEJO__service__DEFAULT_KEEP_EMAIL_PRIVATE: "true"
      FORGEJO__service__ENABLE_NOTIFY_MAIL: "true"
      FORGEJO__service__REGISTER_EMAIL_CONFIRM: "true"
      FORGEJO__mailer__ENABLED: "true"
      FORGEJO__mailer__FROM: "{{ forgejo_mailer_from }}"
      FORGEJO__mailer__MAILER_TYPE: "sendmail"
      FORGEJO__mailer__SENDMAIL_PATH: "/usr/sbin/sendmail"
      FORGEJO__mailer__SENDMAIL_ARGS: "-S {{ inventory_hostname }}.{{ domain }}:25 --"
      FORGEJO__webhook__ALLOWED_HOST_LIST: "external,private,loopback"

- name: cp setup-forgejo.sh /srv/setup-forgejo.sh
  copy:
    src: setup-forgejo.sh
    dest: /srv/setup-forgejo.sh
    mode: 0755

- name: setup forgejo, create or update admin user
  shell: |
    /srv/setup-forgejo.sh "{{ forgejo_user }}" "{{ forgejo_password }}" "{{ forgejo_email }}"
