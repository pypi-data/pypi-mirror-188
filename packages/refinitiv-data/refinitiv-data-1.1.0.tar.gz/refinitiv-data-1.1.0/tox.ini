# tox (https://tox.readthedocs.io/) is a tool for running tests
# in multiple virtualenvs. This configuration file will run the
# test suite on all supported python versions. To use it, "pip install tox"
# and then run "tox" from this directory.

[tox]
envlist = tests-py{37,38,39,310,311}-{nix,win},nbmake
minversion = 3.7
isolated_build = True

[testenv]
passenv = DESKTOP_APP_KEY ENV_NAME PPE_USERNAME PPE_PASSWORD PPE_DESKTOP_APP_KEY EIKON_USERNAME EIKON_PASSWORD
          EDP_USERNAME EDP_PASSWORD EDP_USERNAME_2 EDP_PASSWORD_2 EDP_USERNAME_3 EDP_PASSWORD_3
          RDP_USERNAME RDP_PASSWORD RDP_USERNAME_2 RDP_PASSWORD_2 DEPLOYED_PLATFORM_HOST DEPLOYED_PLATFORM_USER_NAME
setenv =
    PYTHONPATH=.
recreate = true
whitelist_externals =
    win: cmd
    nix: rm
deps =
    allure-pytest
    asyncmock
    coverage
    IPython
    pytest
    pytest-xdist
    pytest-asyncio
    pytest-tornasync
    pytest-cov
    pylint
commands =
    win: cmd /c del *.log *-refinitiv-data-lib
    nix: - rm *.log *-refinitiv-data-lib
    - pip list
    - pylint ./refinitiv
    - coverage run --source=./refinitiv -m pytest -n {env:XDIST_WORKER_COUNT} --dist={env:XDIST_DISTRIBUTION} -v --alluredir=./allure-results {env:TESTS_PATH}
    - pytest -v --lf --last-failed-no-failures none --alluredir=./allure-results {env:TESTS_PATH}
    - coverage report -m
    - coverage xml -o coverage.xml

[testenv:only_desktop_session]
passenv = DESKTOP_APP_KEY EDP_USERNAME EDP_PASSWORD ENV_NAME PPE_USERNAME PPE_PASSWORD PPE_DESKTOP_APP_KEY RDP_USERNAME RDP_PASSWORD DEPLOYED_PLATFORM_HOST DEPLOYED_PLATFORM_USER_NAME
setenv =
    PYTHONPATH=.
recreate = true
whitelist_externals =
    win: cmd
    nix: rm
deps =
    allure-pytest
    asyncmock
    IPython
    pytest
    pytest-asyncio
    pytest-timeout
    pytest-tornasync
commands =
    win: cmd /c del *.log *-refinitiv-data-lib
    nix: - rm *.log *-refinitiv-data-lib
    - pytest -v --alluredir=./allure-results {env:TESTS_PATH} -k "desktop_session"
    - pytest -v --lf --alluredir=./allure-results {env:TESTS_PATH}

[testenv:clean]
deps = coverage
skip_install = true
commands = coverage erase

[testenv:nbmake]
recreate = false
passenv = DESKTOP_APP_KEY EDP_USERNAME EDP_PASSWORD
setenv =
    APP_KEY = {env:DESKTOP_APP_KEY}
    RDP_LOGIN = {env:EDP_USERNAME}
    RDP_PASSWORD = {env:EDP_PASSWORD}
    YOUR_APP_KEY = {env:DESKTOP_APP_KEY}
    YOUR_REFINITIV_DATA_PLATFORM_LOGIN = {env:EDP_USERNAME}
    YOUR_REFINITIV_DATA_PLATFORM_PASSWORD = {env:EDP_PASSWORD}
deps =
    pytest
    nbmake
changedir = ../client_test/notebook/public/
commands =
    - python -m pytest --nbmake "./"

[testenv:smoke]
passenv = DESKTOP_APP_KEY EDP_USERNAME EDP_PASSWORD ENV_NAME PPE_USERNAME PPE_PASSWORD PPE_DESKTOP_APP_KEY RDP_USERNAME RDP_PASSWORD
recreate = true
whitelist_externals =
    win: cmd
    nix: rm
deps =
    allure-pytest
    asyncmock
    IPython
    pytest
    pytest-asyncio
    pytest-tornasync
commands =
    win: cmd /c del *.log *-refinitiv-data-lib
    nix: - rm *.log *-refinitiv-data-lib
    - pytest -v -m smoke --durations=10 --durations-min=10 --alluredir=./allure-results ./tests

