name: Upgrade and Lock Dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # every Monday at midnight

jobs:
  upgrade-deps:
    strategy:
      matrix:
        python-version:
          - "3.7"
          - "3.8"
          - "3.9"
          - "3.10"
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
      fail-fast: true
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-python
        id: setup-python
        with:
          python-version: "${{ matrix.python-version }}"
          # requirements-prefix: tox
      # TODO: I need to manually install tox because the exact lock file
      #       might not be available for the current environment(-markers)
      - name: Install tox
        run: python -m pip install tox
      - name: Upgrade and lock dependencies
        shell: bash
        run: ./bin/tox -e upgrade-deps
      - uses: actions/upload-artifact@v3
        with:
          name: ${{ github.sha }}-${{ github.run_number }}-${{ github.run_attempt }}-requirements
          path: requirements/locked/*.${{ steps.setup-python.outputs.python_version }}-${{ steps.setup-python.outputs.sys_platform }}.txt
          if-no-files-found: error
      - name: List requirements directory
        if: always()
        shell: bash
        run: ls -la requirements/locked/

  create-pull-request:
    needs: upgrade-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: List requirements directory
        shell: bash
        run: ls -la requirements/locked/
      - uses: actions/download-artifact@v3
        with:
          name: ${{ github.sha }}-${{ github.run_number }}-${{ github.run_attempt }}-requirements
          path: requirements/locked/
      - name: List requirements directory
        if: always()
        shell: bash
        run: ls -la requirements/locked/
      - name: Print git diff
        if: always()
        run: git diff
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Upgrade and lock dependencies
          title: Upgrade dependencies
          body: |
            This PR upgrades and locks dependencies to their latest versions.
            (Autogenerated by .github/workflows/upgrade-deps.yaml)
          branch: upgrade-deps
          branch-suffix: timestamp
          delete-branch: true
          labels: |
            dependencies
            skip news
          reviewers: |
            tpvasconcelos
          assignees: |
            tpvasconcelos
          token: ${{ secrets.GITHUB_TOKEN }}
