{% extends 'timeseer.html' %}
{% from 'data-service-header.html' import data_service_breadcrumb, data_service_header with context %}
{% from 'macros.html' import bootstrap_icon %}
{% from 'data-service-menu.html' import data_service_menu with context %}

{% block csp_style %}
'self' 'unsafe-inline'
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='dist/charts.js') }}" nonce="{{ csp_nonce }}"></script>
{% endblock %}

{% block menu %}
{{ data_service_menu(kpi.name) }}
{% endblock %}

{% set title = score.name|capitalize %}

{% block breadcrumb %}
{{
    data_service_breadcrumb(current_bin, [
        (kpi.name, url_for('data_services.kpi_report', binid=current_bin.db_id, kpi=kpi.name, sourcename=source_name)),
        title
    ])
}}
{% endblock %}

{% block main %}
{% call data_service_header(current_bin, title) %}
<div class="row">
    <div class="col-md-auto mt-2 mt-md-0">
        <a  href="{{ url_for('.score_evolution', sourcename=source_name, kpi=kpi.name, score=score.name, binid=current_bin.data_service_view.db_id) }}"
            class="btn btn-primary">
            History
        </a>
    </div>
</div>
{% endcall %}

<div class="pt-3 my-3">
    {% if score.short_help_text %}
    <p>
        {{ score.short_help_text }}
        <a data-bs-toggle="offcanvas"
           href="#score-help-text"
           aria-controls="score-help-text"
           aria-expanded="false">
            {{ bootstrap_icon('question-circle') }}
        </a>
    </p>

    <div class="ts-help-sidebar offcanvas offcanvas-end" tabindex="-1" id="score-help-text">
        <div class="offcanvas-header">
            <h3 class="offcanvas-title h5">{{ score.name }}</h3>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
        {{ score.html_help_text|safe }}
        </div>
    </div>
    {% endif %}

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="{{ url_for('.score_summary', binid=current_bin.db_id, kpi=kpi.name, score=score.name, sourcename=source_name) }}">
                Summary
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('.score_report', binid=current_bin.db_id, kpi=kpi.name, score=score.name, sourcename=source_name) }}">
                Time series
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('.score_event_frames', binid=current_bin.db_id, kpi=kpi.name, score=score.name, sourcename=source_name) }}">
                Event frames
            </a>
        </li>
    </ul>

</div>

<div class="my-3">
    {% if score_distribution|map('last')|sum > 0 %}
    <div class="card card-body mb-3">
        <p>Evaluated over {{ score_distribution|map('last')|sum }} series:</p>
        {% if score.data_type == 'bool' %}
        <div class="score-pie" data-height="300">
            <table class="visually-hidden">
                <tbody>
                    {% for value, count in score_distribution %}
                    {% if value in [0, 90] %}
                    <tr>
                        <td class="pie-label">{{ value }}</td>
                        <td class="pie-value">{{ count }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="histogram" data-score-coloring="yes">
            <table class="visually-hidden">
                <thead>
                    <tr>
                        <th class="histogram-bin-label" colspan="2">{{ score.name }} score</th>
                        <th>Bin start</th>
                        <th>Bin end</th>
                        <th class="histogram-value-label">Number of time series</th>
                    </tr>
                </thead>
                <tbody>
                    {% for value, count in score_distribution %}
                    <tr>
                        <td class="histogram-bin-text">{{ value }} - {{ value + 10 }}</td>
                        <td class="histogram-bin-start">{{ value }}</td>
                        <td class="histogram-bin-end">{{ value + 10 }}</td>
                        <td class="histogram-value">{{ count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script nonce="{{ csp_nonce }}">
(function () {
{% include 'scripts/histogram.js' %}
{% include 'scripts/pie.js' %}
})();
</script>
{% endblock %}
