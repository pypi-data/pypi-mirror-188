{% extends 'timeseer.html' %}
{% from 'resources.html' import resource_breadcrumb %}
{% from 'macros.html' import alerter, info_popover, menu_back, progress_bar, visualize_score, visualize_series_name, visualize_split_kpi_score %}

{% macro compare(a, b) %}
<td>
    {% if a == b %}
    <span>=</span>
    {% elif a > b %}
    <a class="ts-table-link text-decoration-none"
       href="{{ url_for('.compare_bins', binid=current_bin.db_id, comparebinid=compare_bin.db_id, sourcename=source_name) }}">
        <span class="text-danger">{{ b - a }}%</span>
    </a>
    {% else %}
    <a class="ts-table-link text-decoration-none"
       href="{{ url_for('.compare_bins', binid=current_bin.db_id, comparebinid=compare_bin.db_id, sourcename=source_name) }}">
        <span class="text-success">+{{ b - a }}%</span>
    </a>
    {% endif %}
</td>
{% endmacro %}

{% block menu %}
{{ menu_back(url_for('home.home_page', sourcename=source_name)) }}
{% endblock %}

{% block breadcrumb %}
{{
    resource_breadcrumb([
        ("Data services", url_for('data_services.list_data_services', sourcename=source_name)),
        (current_bin.data_service_view.data_service.name, url_for('data_services.configure_data_service', dataservicename=current_bin.data_service_view.data_service.name, sourcename=source_name)),
        current_bin.data_service_view.series_set_name,
    ])
}}
{% endblock %}

{% block csp_style %}
'self' 'unsafe-inline'
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='dist/charts.js') }}" nonce="{{ csp_nonce }}"></script>
{% endblock %}

{% block styles %}
<style nonce="{{ csp_nonce }}">
.ts-score-column {
    width: 5.5rem;
}

.ts-favorite-column {
    width: 16px;
}

#timeseries_source_score {
    max-width: 30rem;
    max-height: 20rem;
}

.ts-series-table {
    table-layout: fixed;
}
</style>
{% endblock %}

{% block main %}
<div class="offcanvas offcanvas-end" tabindex="-1" id="bin-select">
    <div class="offcanvas-header">
        <h3 class="offcanvas-title h5">Evaluations for "{{ current_bin.data_service_view.series_set_name }}" ({{ current_bin.data_service_view.data_service.name }})</h3>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <table class="ts-table table table-borderless mt-3">
            <thead class="thead-secondary">
                <th scope="col">Evaluation bin</th>
            </thead>
            <tbody>
                {% for bin in other_bins|sort(attribute="start_date", reverse=true) %}
                <tr class="border-bottom">
                    <td>
                        {% if bin is not none and bin.db_id != current_bin.db_id %}
                        <a class="ts-table-link text-dark text-decoration-none" href="{{ url_for('.show_data_service_view_bin', binid=bin.db_id, sourcename=source_name) }}">
                            {{ bin.start_date|ts_datetime }} - {{ bin.end_date|ts_datetime }}
                        </a>
                        {% else %}
                        {{ bin.start_date|ts_datetime }} - {{ bin.end_date|ts_datetime }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="ts-section py-3 my-3">
    <div class="row align-items-center">
        <div class="col">
            <h2 class="h4">Results for "{{current_bin.data_service_view.series_set_name }}" ({{ current_bin.data_service_view.data_service.name }})</h2>
        </div>
        <div class="col-lg-auto">
            <form>
                <input type="hidden" name="binid" value="{{ current_bin.db_id }}">
                <div class="btn-toolbar" role="group">

                    <a class="btn btn-secondary me-2" href="{{ url_for('.show_multivariate_statistics', sourcename=source_name, binid=current_bin.db_id) }}">
                        Statistics
                    </a>
                    <div class="btn-group">
                        <a class="btn btn-primary" href="{{ url_for('.list_bins', sourcename=source_name, binid=current_bin.db_id) }}">
                            History
                        </a>
                        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('.open_report', binid=current_bin.db_id, sourcename=source_name) }}" target="_blank">
                                    Open print report
                                    <sup>{{ bootstrap_icon('box-arrow-up-right') }}</sup>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="ts-section pb-3">
    <div class="row align-items-center">
        <div class="col-md-5 ge-2">
            <div class="row align-items-center">
                <div class="fw-bold col-xxl-auto">Date range</div>
                <div class="col-xxl">
                    <a class="btn btn-sm bg-light text-muted text-nowrap"
                        href="#bin-select"
                        data-bs-toggle="offcanvas">
                        {{ current_bin.start_date|ts_datetime }} - {{ current_bin.end_date|ts_datetime }}
                        {{ bootstrap_icon('three-dots-vertical') }}
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md">
            <div class="row align-items-center">
                {% if other_views|count > 1 %}
                <div class="fw-bold col-xxl-auto">Series sets</div>
                <div class="col-xxl">
                    <a class="btn dropdown-toggle btn-sm bg-light text-muted"
                        href="#"
                        role="button"
                        id="editSeriesSetDropdownLink"
                        data-bs-toggle="dropdown"
                        aria-haspopup="true"
                        aria-expanded="false">
                        {{ current_bin.data_service_view.series_set_name }}
                    </a>
                    <div class="dropdown-menu" aria-labelledby="editSeriesSetDropdownLink">
                        {% for view in other_views|sort(attribute='series_set_name') %}
                            {% if view != current_bin.data_service_view %}
                            <a class="dropdown-item" href="{{ url_for('.show_data_service_view', viewid=view.db_id, sourcename=source_name) }}">{{ view.series_set_name }}</a>
                            {% else %}
                            <a class="dropdown-item active">{{ view.series_set_name }}</a>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="fw-bold col-xxl-auto">Series set</div>
                <div class="col-xxl">
                    <a class="btn text-muted btn-sm bg-light pe-none col-lg">
                        {{ current_bin.data_service_view.series_set_name }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md row align-items-center">
            <div class="fw-bold col-xxl-auto">Display</div>
            <div class="dropdown col-sm-auto">
                <button type="button"
                        class="btn btn-sm btn-secondary dropdown-toggle"
                        data-bs-toggle="dropdown"
                        aria-haspopup="true"
                        aria-expanded="false">
                    Scores
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item {% if compare_to is none %}active{% endif %}"
                       href="{{ url_for ('.show_data_service_view_bin_counts', sourcename=source_name, binid=current_bin.db_id, compareTo=compare_bin.db_id if compare_bin is not none else none) }}">
                       Series counts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


{% if analysis_state.is_defined() and not analysis_state.is_completed() %}
    <div class="pt-3 my-3">
        {% call progress_bar(analysis_state, url_for('data_services_api.get_view_analysis_state', dataserviceviewid=current_bin.data_service_view.db_id), label='calculations', empty_is_pending=True) %}
            Analysis
        {% endcall %}
    </div>
{% else %}


<div class="pt-3 my-3">
    <div class="card shadow-sm">
        <div class="card-header">
            <div class="row align-items-center justify-content-between">
                <h3 class="col-sm-6 mb-0 h5">Quality KPI scores</h3>
                {% if kpi_scores|count > 0 and other_bins|count > 2 %}
                <div class="dropdown col-sm-auto">
                    <button type="button"
                            class="btn btn-sm btn-secondary dropdown-toggle"
                            data-bs-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false">
                        Compare to
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <h6 class="dropdown-header">Bins</h6>
                        {% for bin in other_bins|sort(attribute='start_date')|reverse if current_bin.db_id != bin.db_id %}
                        <a class="dropdown-item {% if compare_bin.db_id == bin.db_id %}active{% endif %}"
                           {% if compare_bin.db_id == bin.db_id %}
                           href="{{ url_for('.show_data_service_view_bin', sourcename=source_name, binid=previous_bin.db_id) }}"
                           {% elif bin.db_id != current_bin.db_id %}
                           href="{{ url_for('.show_data_service_view_bin', sourcename=source_name, compareTo=bin.db_id, binid=current_bin.db_id) }}"
                           {% endif %}>
                            {{ bin.start_date|ts_datetime }} - {{ bin.end_date|ts_datetime }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% if kpi_scores|count > 0 %}
        <div class="row gx-0">
            {% if kpi_scores|count > 2 %}
            <div class="col border-end d-flex justify-content-center">
                <div id='timeseries_source_score'></div>
            </div>
            {% endif %}
            <div class="col">
                <table class="ts-table table table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col" colspan="2">
                                <a class="text-reset" href="{{ url_for('kpi_sets.configure_kpi_set', kpisetname=kpi_set.name, sourcename=source_name) }}"
                                   target="_blank">
                                    {{ kpi_set.name }} <sup>{{ bootstrap_icon('box-arrow-up-right') }}</sup>
                                </a>
                            </th>
                            <th scope="col">Score</th>
                            <th scope="col">Evolution</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in kpi_set_entries|sort(attribute='kpi.name') %}
                        {% set kpi = entry.kpi %}
                        <tr class="border-bottom">
                            <td class="ts-favorite-column">
                                {% if entry.favorite %}
                                {{ bootstrap_icon('star-fill', 'text-primary icon') }}
                                {% endif %}
                            </td>
                            <th scope="row">
                                <a class="ts-table-link text-decoration-none text-dark" href="{{ url_for('.kpi_report', kpi=kpi.name, sourcename=source_name, binid=current_bin.db_id) }}">
                                    {{ kpi.name }}
                                </a>
                            </th>
                            {% if kpi.name in kpi_scores %}
                            {{ visualize_score(kpi_scores[kpi.name]) }}
                            {% else %}
                            <td>-</td>
                            {% endif %}
                            {% if kpi.name in kpi_scores and kpi.name in comparison_kpi_scores %}
                            {{ compare(comparison_kpi_scores[kpi.name], kpi_scores[kpi.name]) }}
                            {% else %}
                            <td>-</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="text-muted text-center p-1">
            No results to display.
        </div>
        {% endif %}
    </div>
</div>

{% if current_bin.data_service_view.data_service.time_range.has_no_time_range() is false %}
<div class="mt-4" id="bad-actor-visualization-container">
    <div class="card shadow-sm">
        <div class="card-header">
            <h3 class="mb-0 h5">Bad actor visualization</h3>
        </div>
        <div class="row gx-0">
        <div id="bad-actor-visualization">
            <div class="alert alert-primary mt-2">
                <div class="row align-items-center">
                    <div class="col">
                        Loading chart...
                    </div>
                    <div class="col-auto">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>
{% endif %}


<div class="mt-4">
    <div class="row">
        {% for kpi, scores in kpi_score_scores|dictsort %}
        <div class="col-md-6 mt-4">
            <div class="card shadow-sm h-100 ">
                <div class="card-header">
                    <h3 class="mb-0 h5">{{ kpi|capitalize }}</h3>
                </div>
                <table class="ts-card-table table table-sm table-borderless">
                    <thead class="table-secondary">
                        <tr class="border-bottom">
                            <th scope="col">Name</th>
                            <th scope="col" class="ts-score-column">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if scores|count > 0 %}
                        {% for score in scores|sort(attribute="weight", reverse=True) %}
                        <tr class="border-bottom">
                            <th scope="row">
                                {% if score.metadata.name in multivariate_checks %}
                                <span class="text-dark fw-normal text-decoration-none">
                                    {{ score.metadata.name|capitalize }}
                                </span>
                                {% else %}
                                <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('.score_event_frames', sourcename=source_name, kpi=kpi, score=score.metadata.name, binid=current_bin.db_id) }}">
                                    {{ score.metadata.name|capitalize }}
                                </a>
                                {% endif %}
                                {{ info_popover(score.metadata.short_help_text) }}
                            </th>
                            {{ visualize_score(score.score) }}
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
                {% if scores|count == 0 %}
                <div class="text-muted text-center p-1">
                    No results to display.
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>


<div class="my-4">
    <div class="card shadow-sm">
        <div class="card-header">
            <div class="row align-items-center justify-content-between">
                <h3 class="col-sm-8 mb-0 h5">Worst scoring series</h3>
                {% if worst_series|count > 0 %}
                <form class="col-sm-auto" action="{{ url_for('.series_score_report') }}">
                    <input type="hidden" name="binid" value="{{ current_bin.db_id }}">
                    {% if source_name %}
                    <input type="hidden" name="sourcename" value="{{ source_name }}">
                    {% endif %}
                    <button type="submit" class="btn btn-sm btn-secondary">Display all</button>
                </form>
                {% endif %}
            </div>
        </div>

        {% if worst_series|count > 0 %}
        <table class="ts-card-table ts-series-table table table-sm table-borderless table-hover">
            <thead class="table-secondary">
                <tr class="border-bottom">
                    <th scope="col">Series name</th>
                    <th scope="col">Score</th>
                </tr>
            </thead>
            <tbody>
                {% for series, score in worst_series.items() %}
                <tr class="border-bottom">
                    <th scope="row">
                        <a class="ts-table-link text-dark fw-normal text-decoration-none" href="{{ url_for('data_services.show_event_frames', seriesid=series.series_id, binid=current_bin.db_id) }}"
                        class="text-break">
                            {{ visualize_series_name(series.name) }}
                        </a>
                    </th>
                    {{ visualize_score(score) }}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-muted text-center p-1">
            No results to display.
        </div>
        {% endif %}
    </div>
</div>

<script nonce="{{ csp_nonce }}">
    {% if kpi_scores|count > 2 %}
    {% include 'scripts/kpi-scores-data-service.js' %}
    {% endif %}

    {% if current_bin.data_service_view.data_service.time_range.has_no_time_range() is false %}
    {% include 'scripts/flow-bad-actor-visualization.js' %}

    fetch('{{ url_for("data_services_api.bad_actors_data") }}?' + new URLSearchParams({
        binid: '{{ current_bin.db_id }}',
        includelinks: true,
    }))
        .then(function (response) {
            if (response.status === 200) {
                return response.json();
            } else if (response.status === 408 || response.status === 504) {
                throw new Error('Timeout while loading bad actors visualization data.')
            } else {
                throw new Error('Failed to load bad actors visualization data.')
            }
        }).then(function (data) {
            var chartEl = document.getElementById('bad-actor-visualization');
            while (chartEl.firstChild) {
                chartEl.removeChild(chartEl.lastChild);
            }
            if (data.length == 0) {
                document.getElementById('bad-actor-visualization').innerHTML = `
                        <div class="text-muted text-center p-1">No results to display.</div>
                `
            } else {
                const unhealthyBadActors = updateBadActorsScores(data).filter(badActor => 
                    badActor.tiles.some(tile => tile.score > 0)
                )
                if (unhealthyBadActors.length == 0) {
                    document.getElementById('bad-actor-visualization').innerHTML = `
                        <div class="text-muted text-center p-1">
                            {{ bootstrap_icon('circle-fill', 'text-success align-baseline me-1', 12) }}
                            All series are healthy.
                        </div>
                    `
                } else {
                    plotBadActors(unhealthyBadActors);
                }
            }
        }, function (exception) {
            document.getElementById('bad-actor-visualization').innerHTML = `
                <div class="alert alert-danger mt-2">${exception.message}</div>
            `;
        });
    {% endif %}
</script>
{% endif %}
{% endblock %}

{% block scripts_bottom %}
<script src="{{ url_for('static', filename='dist/data-services.js') }}" nonce="{{ csp_nonce }}"></script>
{% endblock %}
