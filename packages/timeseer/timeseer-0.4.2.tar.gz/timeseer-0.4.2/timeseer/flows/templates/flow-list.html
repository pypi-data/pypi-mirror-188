{% extends 'timeseer.html' %}
{% from 'macros.html' import info_popover, bootstrap_icon, schedule_popover %}
{% from 'resources.html' import resource_breadcrumb, resource_menu with context %}

{% block menu %}
{{ resource_menu('Flows') }}
{% endblock %}

{% block breadcrumb %}
{{ resource_breadcrumb(["Flows"]) }}
{% endblock %}

{% block main %}
<div class="ts-section pb-3 mb-3">
    <div class="row justify-content-between">
        <h2 class="col-sm-6 h4">Flows</h2>
        <div class="col-sm-auto">
          <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#createFlowOffCanvas">
                Create new
            </button>
        </div>
    </div>
</div>

{% if flows|count == 0 %}
    <div class="row justify-content-center mt-3">
    {{ bootstrap_icon('shuffle', 'text-secondary', size=32) }}
    </div>
    <h4 class="col text-center">You haven't created a flow</h4>
    <div class="row justify-content-center mt-3">
        <div class="col-sm-6 text-center">Timeseer's logic is presented in blocks, which can be evaluated in a specific order defined by flows.</div>
    </div>
    <div class="row justify-content-center mt-3">
        <button class="btn btn-primary col-sm-auto" data-bs-toggle="offcanvas" data-bs-target="#createFlowOffCanvas">
            Create flow
        </button>
    </div>
{% endif %}

<div class="pt-3 my-3">
    <form>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="row align-items-center gx-2 pb-3">
            {% if flows and flows|selectattr('origin.value', 'in', ['ui', 'control loop'])|list|count > 0 %}
            <div class="col-md-auto">
                <div class="btn-group ts-dropdown-select-button">
                    <a class="btn border border-secondary dropdown-toggle"
                    href="#"
                    role="button"
                    id="selectionDropdown"
                    data-bs-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false">
                    </a>
                    <div class="dropdown-menu" aria-labelledby="selectionDropdown">
                        <button type="submit"
                                class="dropdown-item ts-dropdown-action"
                                formmethod="POST"
                                formaction="{{ url_for('.remove_multiple_flows', sourcename=source_name) }}"
                                >
                                Remove selected
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <table class="ts-table ts-table-checkbox table table-borderless mt-3" data-ts-target="selectionDropdown">
            <thead class="thead-secondary">
                <th scope="col">
                    {% if flows|count > 0 and flows|selectattr('origin.value', 'in', ['ui', 'control loop'])|list|count > 0 %}
                    <input class="form-check-input" type="checkbox">
                    {% endif %}
                </th>
                <th scope="col">Flow name</th>
                <th scope="col">Flow type</th>
                <th scope="col">Schedule</th>
            </thead>
            <tbody>
                {% for flow in flows|sort(attribute='name') %}
                <tr class="border-bottom">
                    <td>
                        {% if flow.origin.value in ['ui', 'control loop'] %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="{{ flow.name }}">
                        </div>
                        {% else %}
                        {{ info_popover('Generated by Timeseer or created in the configuration.', 'lock', 'text-muted', placement="top") }}
                        {% endif %}
                    </td>
                    <td>
                        <input type="hidden" name="flownames" value="{{ flow.name }}">
                        <a class="ts-table-link text-dark text-decoration-none" href="{{ url_for('.display_flow', flowname=flow.name, sourcename=source_name) }}">
                        {{ flow.name }}

                        </a>
                    </td>
                    {% if flow.origin.value in ['ui', 'control loop'] %}
                    <td class="text-muted">Custom</td>
                    {% elif flow.origin.value == 'resource' %}
                    <td class="text-muted">Configuration</td>
                    {% else %}
                    <td class='text-muted align-text-bottom'><img src="{{ url_for('static', filename='icon.png') }}" width="16"> <span class="align-middle">Default</span></td>
                    {% endif %}
                    {% if scheduled_flows.get(flow.db_id) is not none %}
                    {% set schedule = scheduled_flows.get(flow.db_id).schedule %}
                    <td>
                      {% if schedule.initial_date is not none and schedule.initial_date > time_now_utc %}
                            {% if schedule.frequency > 1 %}
                            {{ 'Every ' + schedule.frequency|string + ' ' + schedule.interval.value + 's, starting on ' + schedule.initial_date|ts_datetime }}
                            {% else %}
                            {{ 'Every ' + schedule.interval.value + ', starting on ' + schedule.initial_date|ts_datetime }}
                            {% endif %}
                        {% else %}
                            {% if schedule.frequency > 1 %}
                            {{ 'Every ' + schedule.frequency|string + ' ' + schedule.interval.value + 's' }}
                            {% else %}
                            {{ 'Every ' + schedule.interval.value }}
                            {% endif %}
                        {% endif %}
                    </td>
                    {% else %}
                    <td>-</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="createFlowOffCanvas">
    <div class="offcanvas-header ts-section bg-light">
        <h4 class="offcanvas-title">Create flow</h4>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="define-flow"
            data-config-url="{{ url_for('.get_create_config', sourcename=source_name) }}">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_bottom %}
<script src="{{ url_for('static', filename='dist/define-flow.js') }}" nonce="{{ csp_nonce }}"></script>
{% endblock %}
